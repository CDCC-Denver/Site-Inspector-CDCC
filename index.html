<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>Site Inspector Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--blue:#1e3a5f;--blue-light:#2d5a8e;--blue-dark:#0f2440;--accent:#f59e0b;--green:#22c55e;--red:#ef4444;--g50:#f8fafc;--g100:#f1f5f9;--g200:#e2e8f0;--g500:#64748b;--g700:#334155;--g900:#0f172a;--radius:12px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--g100);color:var(--g900);min-height:100vh;-webkit-tap-highlight-color:transparent}
.screen{display:none;min-height:100vh;flex-direction:column}
.screen.active{display:flex}
button{-webkit-appearance:none;font-family:inherit}
.top-bar{background:var(--blue);color:#fff;padding:14px 20px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:50}
.top-bar h2{font-size:17px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.top-bar .back-btn{background:none;border:none;color:#fff;font-size:22px;cursor:pointer;padding:2px 6px}
.top-bar .badge{background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:16px;font-size:12px;font-weight:600}
.accent-line{height:3px;background:var(--accent)}
.body-content{flex:1;padding:16px;padding-bottom:100px;overflow-y:auto}
.btn{padding:14px 24px;border:none;border-radius:var(--radius);font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;width:100%;transition:all 0.15s}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--accent);color:var(--blue-dark)}
.btn-success{background:var(--green);color:#fff}
.btn-outline{background:#fff;color:var(--blue);border:2px solid var(--g200)}
.btn-sm{padding:10px 16px;font-size:13px}
.bottom-bar{position:fixed;bottom:0;left:0;right:0;padding:14px 16px;background:#fff;border-top:1px solid var(--g200);display:flex;gap:10px;z-index:50}
.bottom-bar .btn{flex:1}
.card{background:#fff;border-radius:var(--radius);box-shadow:0 1px 4px rgba(0,0,0,0.06);overflow:hidden;margin-bottom:12px}
.input-group{margin-bottom:16px}
.input-group label{display:block;font-size:12px;font-weight:600;color:var(--g500);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:6px}
.input-group input{width:100%;padding:12px;border:2px solid var(--g200);border-radius:8px;font-size:15px;font-family:inherit;outline:none;background:#fff}
.input-group input:focus{border-color:var(--blue-light)}
input[type="file"]{display:none}

/* HOME */
.home-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;background:linear-gradient(135deg,var(--blue-dark),var(--blue-light));color:#fff;text-align:center}
.home-content .app-icon{font-size:56px;margin-bottom:16px}
.home-content h1{font-size:24px;font-weight:700;margin-bottom:4px}
.home-content .sub{font-size:13px;opacity:0.7;margin-bottom:40px}
.home-box{background:rgba(255,255,255,0.1);border-radius:var(--radius);padding:24px;width:100%;max-width:400px;backdrop-filter:blur(10px)}
.home-box h3{font-size:15px;margin-bottom:12px}
.home-box input{width:100%;padding:14px;border:2px solid rgba(255,255,255,0.2);border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;font-size:16px;outline:none;margin-bottom:12px}
.home-box input::placeholder{color:rgba(255,255,255,0.4)}
.recent-list{margin-top:20px;width:100%;max-width:400px}
.recent-list h4{font-size:12px;text-transform:uppercase;opacity:0.6;margin-bottom:8px;letter-spacing:0.5px}
.recent-item{background:rgba(255,255,255,0.1);border-radius:8px;padding:14px;margin-bottom:8px;cursor:pointer;text-align:left;border:none;width:100%;color:#fff;font-size:15px;font-weight:500;transition:background 0.15s}
.recent-item:active{background:rgba(255,255,255,0.2)}
.recent-item .ri-date{font-size:11px;opacity:0.6;margin-top:2px;font-weight:400}

/* CAPTURE */
.capture-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:20px}
.take-photo-btn{width:110px;height:110px;border-radius:50%;border:4px solid var(--blue);background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
.take-photo-btn:active{background:var(--blue)}
.take-photo-btn:active span{color:#fff}
.tp-icon{font-size:36px}
.tp-label{font-size:10px;font-weight:700;text-transform:uppercase;color:var(--blue);letter-spacing:0.5px}
.photo-entry{width:100%;max-width:500px;background:#fff;border-radius:var(--radius);overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.08);margin:0 auto}
.photo-entry img{width:100%;height:200px;object-fit:cover}
.voice-area{padding:14px}
.voice-status{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:10px;border-radius:8px;font-size:13px;font-weight:500}
.voice-status.listening{background:#fef3c7;color:#92400e}
.voice-status.done{background:#d1fae5;color:#065f46}
.voice-status.unavail{background:var(--g100);color:var(--g700)}
.pulse-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);animation:pulse 1.2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.3)}}
.voice-area textarea{width:100%;padding:12px;border:2px solid var(--g200);border-radius:8px;font-size:15px;resize:vertical;min-height:70px;font-family:inherit;outline:none}
.voice-area textarea:focus{border-color:var(--blue-light)}
.btn-row{display:flex;gap:8px;margin-top:10px}
.btn-row .btn{flex:1}
.photo-strip{display:flex;gap:8px;overflow-x:auto;padding:10px 16px;-webkit-overflow-scrolling:touch}
.photo-strip:empty{display:none}
.photo-thumb{width:54px;height:54px;border-radius:6px;object-fit:cover;border:2px solid var(--g200);flex-shrink:0}

/* REVIEW */
.review-item{background:#fff;border-radius:var(--radius);overflow:hidden;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}
.ri-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--g50);border-bottom:1px solid var(--g200)}
.ri-header span{font-weight:600;font-size:13px;color:var(--blue)}
.del-btn{background:none;border:none;color:var(--red);font-size:18px;cursor:pointer;padding:4px 8px}
.review-item img{width:100%;height:180px;object-fit:cover}
.review-item p{padding:10px 14px;font-size:13px;color:var(--g700);line-height:1.5}

/* COMPLETE */
.complete-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 24px;gap:16px;background:linear-gradient(135deg,var(--blue-dark),var(--blue-light));color:#fff}
.complete-icon{width:72px;height:72px;background:var(--green);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px}
.complete-msg{font-size:13px;opacity:0.8;max-width:360px;line-height:1.6}
.share-card{background:rgba(255,255,255,0.12);border-radius:var(--radius);padding:18px;text-align:left;cursor:pointer;border:2px solid rgba(255,255,255,0.15);width:100%;max-width:380px;transition:all 0.15s}
.share-card:active{background:rgba(255,255,255,0.2);transform:scale(0.98)}
.share-card h3{font-size:15px;margin-bottom:3px}
.share-card p{font-size:12px;opacity:0.7;margin:0}

/* OVERLAY */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;flex-direction:column;align-items:center;justify-content:center;gap:14px;color:#fff}
.overlay.active{display:flex}
.spinner{width:44px;height:44px;border:4px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay-text{font-size:14px;opacity:0.9;text-align:center;max-width:280px}
</style>
</head>
<body>

<!-- HOME -->
<div id="homeScreen" class="screen active">
  <div class="home-content">
    <div class="app-icon">üìã</div>
    <h1>Site Inspector Pro</h1>
    <div class="sub">Construction Draw Inspections</div>
    <div class="home-box">
      <h3>Project Name</h3>
      <input type="text" id="projectInput" placeholder="e.g. 123 Main St ‚Äî Draw #3">
      <button class="btn btn-primary" onclick="startInspection()">Start Inspection ‚Üí</button>
    </div>
    <div class="recent-list" id="recentList"></div>
  </div>
</div>

<!-- CAPTURE -->
<div id="captureScreen" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="confirmExitCapture()">‚Üê</button>
    <h2 id="captureTitle">Inspection</h2>
    <div class="badge"><span id="photoCountLabel">0</span> Photos</div>
  </div>
  <div id="captureArea" class="capture-area">
    <div class="take-photo-btn" onclick="document.getElementById('cameraInput').click()">
      <span class="tp-icon">üì∑</span>
      <span class="tp-label">Take Photo</span>
    </div>
    <p style="font-size:13px;color:var(--g500);text-align:center">Tap to take a photo, then<br>speak your description</p>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handlePhoto(this)">
  </div>
  <div id="voiceArea" style="display:none;flex:1;padding:16px;padding-bottom:100px">
    <div class="photo-entry">
      <img id="previewImg" src="">
      <div class="voice-area">
        <div id="voiceStatus" class="voice-status listening">
          <div class="pulse-dot"></div><span>Listening...</span>
        </div>
        <textarea id="descriptionInput" placeholder="Description will appear here..."></textarea>
        <div class="btn-row">
          <button class="btn btn-outline btn-sm" onclick="restartVoice()">üé§ Redo</button>
          <button class="btn btn-primary btn-sm" onclick="saveCurrentPhoto()">Save ‚úì</button>
        </div>
      </div>
    </div>
  </div>
  <div id="photoStrip" class="photo-strip"></div>
  <div class="bottom-bar">
    <button class="btn btn-outline" onclick="showReview()" style="background:#fff;color:var(--g700)">Review</button>
    <button class="btn btn-success" onclick="showReview()">Complete ‚úì</button>
  </div>
</div>

<!-- REVIEW -->
<div id="reviewScreen" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="backToCapture()">‚Üê</button>
    <h2>Review Photos</h2>
  </div>
  <div class="accent-line"></div>
  <div class="body-content" id="reviewList"></div>
  <div class="bottom-bar">
    <button class="btn btn-outline" onclick="backToCapture()" style="background:#fff;color:var(--g700)">+ More</button>
    <button class="btn btn-success" onclick="generateReports()">Generate Reports</button>
  </div>
</div>

<!-- COMPLETE -->
<div id="completeScreen" class="screen">
  <div class="complete-content">
    <div class="complete-icon">‚úì</div>
    <h2 style="font-size:22px">Reports Ready</h2>
    <div class="complete-msg" id="completeMsg"></div>
    <div class="share-card" onclick="shareToDropbox()">
      <h3>üì§ Share to Dropbox</h3>
      <p>Send both PDFs to your Dropbox project folder</p>
    </div>
    <div class="share-card" onclick="downloadReports()">
      <h3>üíæ Download to Phone</h3>
      <p>Save PDFs to your Downloads folder</p>
    </div>
    <button class="btn" style="background:rgba(255,255,255,0.15);color:#fff;max-width:380px;margin-top:8px" onclick="goHome()">Done ‚Äî New Inspection</button>
  </div>
</div>

<!-- OVERLAY -->
<div id="overlay" class="overlay">
  <div class="spinner"></div>
  <div class="overlay-text" id="overlayText">Working...</div>
</div>

<script>
// =============================================
// STATE
// =============================================
let projectName = '';
let inspection = { photos: [], currentImageData: null, date: '', time: '', dateShort: '' };
let recognition = null;
let photoBlob = null;
let narrativeBlob = null;

// =============================================
// NAVIGATION
// =============================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}
function showOverlay(t) { document.getElementById('overlayText').textContent = t; document.getElementById('overlay').classList.add('active'); }
function hideOverlay() { document.getElementById('overlay').classList.remove('active'); }

// =============================================
// HOME / RECENT PROJECTS
// =============================================
function goHome() {
  showScreen('homeScreen');
  loadRecents();
}

function loadRecents() {
  const recents = JSON.parse(localStorage.getItem('recent_projects') || '[]');
  const el = document.getElementById('recentList');
  if (recents.length === 0) { el.innerHTML = ''; return; }
  el.innerHTML = '<h4>Recent Projects</h4>' +
    recents.slice(0, 8).map(r => `
      <button class="recent-item" onclick="document.getElementById('projectInput').value='${esc(r.name)}';startInspection()">
        ${esc(r.name)}
        <div class="ri-date">Last inspected: ${r.date}</div>
      </button>
    `).join('');
}

function saveRecent(name) {
  let recents = JSON.parse(localStorage.getItem('recent_projects') || '[]');
  recents = recents.filter(r => r.name !== name);
  recents.unshift({ name, date: new Date().toLocaleDateString() });
  if (recents.length > 20) recents = recents.slice(0, 20);
  localStorage.setItem('recent_projects', JSON.stringify(recents));
}

// =============================================
// INSPECTION
// =============================================
function startInspection() {
  const name = document.getElementById('projectInput').value.trim();
  if (!name) { document.getElementById('projectInput').style.borderColor = '#ef4444'; return; }
  projectName = name;
  const now = new Date();
  inspection = {
    photos: [], currentImageData: null,
    date: now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
    time: now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
    dateShort: now.toISOString().split('T')[0]
  };
  photoBlob = null; narrativeBlob = null;
  document.getElementById('captureTitle').textContent = projectName;
  document.getElementById('photoCountLabel').textContent = '0';
  document.getElementById('photoStrip').innerHTML = '';
  showCaptureMode();
  showScreen('captureScreen');
}

function handlePhoto(input) {
  if (!input.files || !input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas');
      const MAX = 1200;
      let w = img.width, h = img.height;
      if (w > MAX) { h *= MAX / w; w = MAX; }
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      inspection.currentImageData = c.toDataURL('image/jpeg', 0.75);
      showVoiceMode();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(input.files[0]);
  input.value = '';
}

function showVoiceMode() {
  document.getElementById('captureArea').style.display = 'none';
  document.getElementById('voiceArea').style.display = 'block';
  document.getElementById('previewImg').src = inspection.currentImageData;
  document.getElementById('descriptionInput').value = '';
  startSpeech();
}

function showCaptureMode() {
  document.getElementById('captureArea').style.display = 'flex';
  document.getElementById('voiceArea').style.display = 'none';
  stopSpeech();
}

function saveCurrentPhoto() {
  stopSpeech();
  inspection.photos.push({
    imageData: inspection.currentImageData,
    description: document.getElementById('descriptionInput').value.trim() || '(No description)',
    timestamp: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
  });
  inspection.currentImageData = null;
  document.getElementById('photoCountLabel').textContent = inspection.photos.length;
  const strip = document.getElementById('photoStrip');
  strip.innerHTML = inspection.photos.map(p => '<img class="photo-thumb" src="' + p.imageData + '">').join('');
  strip.scrollLeft = strip.scrollWidth;
  showCaptureMode();
}

function confirmExitCapture() {
  if (inspection.photos.length > 0 && !confirm('Exit? Your photos will be lost.')) return;
  stopSpeech(); goHome();
}

// =============================================
// SPEECH
// =============================================
function startSpeech() {
  const el = document.getElementById('voiceStatus');
  const ta = document.getElementById('descriptionInput');
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    el.className = 'voice-status unavail';
    el.innerHTML = '<span>üé§ Voice unavailable ‚Äî type below</span>';
    ta.focus(); return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'en-US';
  let final = '';
  recognition.onresult = e => {
    let interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript + ' ';
      else interim += e.results[i][0].transcript;
    }
    ta.value = final + interim;
  };
  recognition.onend = () => {
    el.className = 'voice-status done';
    el.innerHTML = '<span style="font-size:16px">‚úì</span><span>Done ‚Äî edit if needed</span>';
  };
  recognition.onerror = () => {};
  el.className = 'voice-status listening';
  el.innerHTML = '<div class="pulse-dot"></div><span>Listening...</span>';
  try { recognition.start(); } catch(e) {
    el.className = 'voice-status unavail';
    el.innerHTML = '<span>üé§ Voice unavailable ‚Äî type below</span>';
  }
}
function stopSpeech() { if (recognition) { try { recognition.stop(); } catch(e) {} recognition = null; } }
function restartVoice() { stopSpeech(); document.getElementById('descriptionInput').value = ''; startSpeech(); }

// =============================================
// REVIEW
// =============================================
function showReview() {
  stopSpeech();
  if (inspection.currentImageData) {
    inspection.photos.push({
      imageData: inspection.currentImageData,
      description: document.getElementById('descriptionInput').value.trim() || '(No description)',
      timestamp: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
    });
    inspection.currentImageData = null;
    document.getElementById('photoCountLabel').textContent = inspection.photos.length;
    showCaptureMode();
  }
  if (inspection.photos.length === 0) { alert('Take at least one photo.'); return; }
  document.getElementById('reviewList').innerHTML = inspection.photos.map((p, i) =>
    '<div class="review-item">' +
      '<div class="ri-header"><span>Photo ' + (i+1) + ' ‚Äî ' + p.timestamp + '</span>' +
      '<button class="del-btn" onclick="delPhoto(' + i + ')">‚úï</button></div>' +
      '<img src="' + p.imageData + '"><p>' + esc(p.description) + '</p></div>'
  ).join('');
  showScreen('reviewScreen');
}

function delPhoto(i) {
  if (!confirm('Delete?')) return;
  inspection.photos.splice(i, 1);
  document.getElementById('photoCountLabel').textContent = inspection.photos.length;
  if (inspection.photos.length === 0) backToCapture(); else showReview();
}
function backToCapture() { showCaptureMode(); showScreen('captureScreen'); }

// =============================================
// GENERATE REPORTS
// =============================================
async function generateReports() {
  showOverlay('Generating photo report...');
  await sleep(80);
  try {
    photoBlob = genPhotoReportPDF();
    document.getElementById('overlayText').textContent = 'Generating narrative...';
    await sleep(80);
    narrativeBlob = genNarrativePDF();
    saveRecent(projectName);
    hideOverlay();
    document.getElementById('completeMsg').innerHTML =
      '<strong>' + inspection.photos.length + ' photos</strong> documented for<br><strong>' + esc(projectName) + '</strong><br>' + inspection.date;
    showScreen('completeScreen');
  } catch (e) {
    hideOverlay();
    alert('Error: ' + e.message);
  }
}

// =============================================
// SHARE & DOWNLOAD
// =============================================
async function shareToDropbox() {
  const safeName = projectName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_');
  const d = inspection.dateShort;
  const files = [
    new File([photoBlob], safeName + '_Photo_Report_' + d + '.pdf', { type: 'application/pdf' }),
    new File([narrativeBlob], safeName + '_Narrative_' + d + '.pdf', { type: 'application/pdf' })
  ];

  if (navigator.canShare && navigator.canShare({ files })) {
    try {
      await navigator.share({
        title: projectName + ' ‚Äî Inspection ' + d,
        text: 'Inspection reports for ' + projectName,
        files: files
      });
    } catch (e) {
      if (e.name !== 'AbortError') {
        alert('Share failed. Try downloading instead.');
      }
    }
  } else {
    // Fallback: share one at a time
    const file1 = [files[0]];
    const file2 = [files[1]];
    if (navigator.canShare && navigator.canShare({ files: file1 })) {
      try {
        alert('Your phone will open the share menu twice ‚Äî once for each report.');
        await navigator.share({ title: 'Photo Report', files: file1 });
        await navigator.share({ title: 'Narrative', files: file2 });
      } catch (e) {
        if (e.name !== 'AbortError') downloadReports();
      }
    } else {
      alert('Sharing not supported on this browser. Downloading instead.');
      downloadReports();
    }
  }
}

function downloadReports() {
  const safeName = projectName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_');
  const d = inspection.dateShort;
  dlBlob(photoBlob, safeName + '_Photo_Report_' + d + '.pdf');
  setTimeout(() => dlBlob(narrativeBlob, safeName + '_Narrative_' + d + '.pdf'), 500);
}

// =============================================
// PDF: PHOTO REPORT
// =============================================
function genPhotoReportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('portrait', 'mm', 'letter');
  const W = 215.9, H = 279.4, M = 14;
  const uW = W - M * 2, gap = 8, cW = (uW - gap) / 2;
  const photos = inspection.photos, pp = 6;
  const pages = Math.ceil(photos.length / pp);

  for (let pg = 0; pg < pages; pg++) {
    if (pg > 0) doc.addPage();
    doc.setFillColor(30, 58, 95); doc.rect(0, 0, W, 26, 'F');
    doc.setTextColor(255); doc.setFontSize(13); doc.setFont('helvetica', 'bold');
    doc.text(projectName, M, 11);
    doc.setFontSize(8); doc.setFont('helvetica', 'normal');
    doc.text(inspection.date + '  |  ' + inspection.time, M, 18);
    doc.text('Page ' + (pg + 1) + ' of ' + pages, W - M, 18, { align: 'right' });
    doc.setDrawColor(245, 158, 11); doc.setLineWidth(0.8); doc.line(M, 27, W - M, 27);

    var y0 = 31, rH = (H - y0 - M - 4) / 3, iH = rH - 20;
    for (var i = 0; i < pp; i++) {
      var idx = pg * pp + i;
      if (idx >= photos.length) break;
      var p = photos[idx];
      var col = i % 2, row = Math.floor(i / 2);
      var x = M + col * (cW + gap), y = y0 + row * rH;

      doc.setFillColor(30, 58, 95);
      doc.roundedRect(x, y, 14, 5, 1, 1, 'F');
      doc.setTextColor(255); doc.setFontSize(6.5); doc.setFont('helvetica', 'bold');
      doc.text('#' + (idx + 1), x + 7, y + 3.5, { align: 'center' });
      doc.setDrawColor(200); doc.setLineWidth(0.3); doc.rect(x, y + 6, cW, iH);
      try { doc.addImage(p.imageData, 'JPEG', x + 0.5, y + 6.5, cW - 1, iH - 1); } catch(e) {}
      doc.setTextColor(51, 65, 85); doc.setFontSize(7.5); doc.setFont('helvetica', 'normal');
      doc.text(doc.splitTextToSize(p.description, cW - 2).slice(0, 3), x + 1, y + iH + 10);
    }
    doc.setTextColor(150); doc.setFontSize(6);
    doc.text('Site Inspector Pro', W / 2, H - 5, { align: 'center' });
  }
  return doc.output('blob');
}

// =============================================
// PDF: NARRATIVE
// =============================================
function genNarrativePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('portrait', 'mm', 'letter');
  const W = 215.9, H = 279.4, M = 20, uW = W - M * 2;
  const photos = inspection.photos;

  doc.setFillColor(30, 58, 95); doc.rect(0, 0, W, 34, 'F');
  doc.setTextColor(255); doc.setFontSize(16); doc.setFont('helvetica', 'bold');
  doc.text('Construction Progress Narrative', M, 14);
  doc.setFontSize(10); doc.setFont('helvetica', 'normal');
  doc.text(projectName, M, 22);
  doc.setFontSize(8);
  doc.text(inspection.date + '  |  ' + inspection.time + '  |  ' + photos.length + ' photos', M, 29);
  doc.setDrawColor(245, 158, 11); doc.setLineWidth(0.8); doc.line(M, 35.5, W - M, 35.5);

  var y = 42;
  function addSec(heading, text) {
    if (y > H - 30) { doc.addPage(); y = 20; }
    if (heading) {
      doc.setFontSize(11); doc.setFont('helvetica', 'bold'); doc.setTextColor(30, 58, 95);
      doc.text(heading, M, y); y += 6;
    }
    if (text) {
      doc.setFontSize(9.5); doc.setFont('helvetica', 'normal'); doc.setTextColor(51, 65, 85);
      doc.splitTextToSize(text, uW).forEach(function(l) {
        if (y > H - 16) { doc.addPage(); y = 20; }
        doc.text(l, M, y); y += 4.5;
      });
    }
    y += 4;
  }

  addSec('Inspection Overview',
    'A construction site inspection was conducted on ' + inspection.date + ' at approximately ' + inspection.time + ' for the project "' + projectName + '". The inspector documented ' + photos.length + ' photograph' + (photos.length !== 1 ? 's' : '') + ' during the site visit. The following narrative summarizes observations recorded during the inspection.');

  addSec('Detailed Observations');
  photos.forEach(function(p, i) {
    var d = (p.description && p.description !== '(No description)') ? p.description.trim() : null;
    var txt;
    if (d) {
      var s = d.charAt(0).toUpperCase() + d.slice(1);
      if (!/[.!?]$/.test(s)) s += '.';
      txt = 'Observation ' + (i + 1) + ' (' + p.timestamp + '): ' + s;
    } else {
      txt = 'Observation ' + (i + 1) + ' (' + p.timestamp + '): Photo documented; no description recorded.';
    }
    addSec(null, txt);
  });

  var allText = photos.map(function(p) { return p.description; }).join(' ').toLowerCase();
  var topics = [];
  [
    [/foundation|footing|slab|concrete|pour/i, 'foundation/concrete'],
    [/frame|framing|stud|truss|joist|rafter/i, 'framing'],
    [/roof|shingle|flashing|gutter/i, 'roofing'],
    [/plumb|pipe|drain|water|sewer/i, 'plumbing'],
    [/electric|wire|panel|outlet|conduit/i, 'electrical'],
    [/hvac|duct|furnace|air\s*condition|mechanical/i, 'HVAC/mechanical'],
    [/drywall|mud|tape|texture|paint/i, 'interior finishes'],
    [/window|door|trim|cabinet|counter|floor|tile/i, 'finish materials'],
    [/insul|vapor|barrier|wrap/i, 'insulation'],
    [/grade|land|dirt|excav|site\s*work|drive|pav/i, 'site work'],
    [/damage|issue|problem|concern|defect|crack|leak/i, 'potential deficiencies']
  ].forEach(function(pair) { if (pair[0].test(allText)) topics.push(pair[1]); });

  var summary = photos.length + ' area' + (photos.length !== 1 ? 's were' : ' was') + ' documented. ';
  if (topics.length) summary += 'Key areas of work observed: ' + topics.join(', ') + '. ';
  summary += "Photographs and descriptions herein represent the inspector's observations at the time of the site visit.";
  addSec('Summary', summary);

  addSec('Disclaimer',
    'This report is based solely on visual observations made during the inspection. The inspection was limited to readily accessible and visible areas. No destructive or invasive testing was performed. Conditions may exist that were not visible at the time of inspection.');

  var pc = doc.internal.getNumberOfPages();
  for (var i = 1; i <= pc; i++) {
    doc.setPage(i); doc.setTextColor(150); doc.setFontSize(6);
    doc.text('Site Inspector Pro', W / 2, H - 5, { align: 'center' });
    doc.text('Page ' + i + ' of ' + pc, W - M, H - 5, { align: 'right' });
  }
  return doc.output('blob');
}

// =============================================
// UTILS
// =============================================
function dlBlob(blob, name) {
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = name;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function esc(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

// INIT
loadRecents();
</script>
</body>
</html>